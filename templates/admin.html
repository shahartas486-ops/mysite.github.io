{% extends "base.html" %}

{% block title %}Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª - Ù…ÙˆØ¨Ø§ÛŒÙ„{% endblock %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Vazir', 'Tahoma', sans-serif;
    }
    
    body {
        background: #f0f2f5;
        direction: rtl;
    }
    
    .admin-panel {
        padding: 10px;
        max-width: 100%;
        margin: 0 auto;
    }
    
    /* Ù‡Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
    .mobile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    .mobile-header h1 {
        font-size: 1.5rem;
        margin: 0;
    }
    
    .stats-badge {
        background: rgba(255,255,255,0.2);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        backdrop-filter: blur(5px);
    }
    
    /* Ù…Ù†ÙˆÛŒ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø¨ÛŒÙ† Ø¨Ø®Ø´â€ŒÙ‡Ø§ */
    .bottom-nav {
        display: flex;
        background: white;
        border-radius: 30px;
        margin-bottom: 15px;
        padding: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .nav-item {
        flex: 1;
        text-align: center;
        padding: 12px 0;
        font-size: 0.9rem;
        border-radius: 25px;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .nav-item.active {
        background: #667eea;
        color: white;
        font-weight: bold;
    }
    
    /* Ø¨Ø®Ø´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ù…ÙˆØ¨Ø§ÛŒÙ„) */
    .users-section {
        background: white;
        border-radius: 20px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: none;
    }
    
    .users-section.active {
        display: block;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .section-header h2 {
        font-size: 1.2rem;
        color: #333;
    }
    
    .refresh-btn {
        background: #667eea;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    /* Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù‡ ØµÙˆØ±Øª Ú©Ø§Ø±ØªÛŒ */
    .users-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .user-card {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .user-card:active {
        transform: scale(0.98);
        background: #e9ecef;
    }
    
    .user-card.active {
        border-color: #667eea;
        background: #f0f2ff;
    }
    
    .user-avatar {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin-left: 12px;
    }
    
    .user-info {
        flex: 1;
    }
    
    .user-name {
        font-weight: bold;
        font-size: 1rem;
        margin-bottom: 4px;
    }
    
    .user-meta {
        display: flex;
        gap: 10px;
        font-size: 0.8rem;
        color: #666;
    }
    
    /* Ø¨Ø®Ø´ Ú†Øª */
    .chat-section {
        background: white;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        height: 60vh;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: none;
    }
    
    .chat-section.active {
        display: flex;
    }
    
    .chat-header {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 20px 20px 0 0;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .back-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #667eea;
        cursor: pointer;
        padding: 5px;
    }
    
    .selected-user-info {
        flex: 1;
    }
    
    .selected-user-name {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .selected-user-status {
        font-size: 0.8rem;
        color: #28a745;
    }
    
    /* Ù…Ø­ÙØ¸Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .message {
        max-width: 85%;
        padding: 10px 12px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message.user {
        align-self: flex-end;
        background: #667eea;
        color: white;
        border-bottom-left-radius: 4px;
    }
    
    .message.ai, .message.admin {
        align-self: flex-start;
        background: #f1f3f5;
        color: #333;
        border-bottom-right-radius: 4px;
    }
    
    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.7rem;
        margin-bottom: 4px;
        opacity: 0.7;
    }
    
    .message-content {
        font-size: 0.95rem;
        line-height: 1.4;
    }
    
    .message-image, .message-video {
        max-width: 100%;
        border-radius: 10px;
        margin-top: 5px;
    }
    
    .message-audio {
        width: 100%;
        margin-top: 5px;
    }
    
    .message-file {
        display: inline-block;
        padding: 8px 12px;
        background: #28a745;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    /* ÙØ±Ù… Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… */
    .message-form {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 0 0 20px 20px;
        border-top: 1px solid #dee2e6;
    }
    
    .message-type-row {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
        overflow-x: auto;
        padding: 5px 0;
        -webkit-overflow-scrolling: touch;
    }
    
    .type-btn {
        padding: 8px 15px;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        background: white;
        font-size: 0.9rem;
        white-space: nowrap;
        cursor: pointer;
    }
    
    .type-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .input-area {
        margin-bottom: 10px;
    }
    
    .text-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        font-size: 1rem;
        resize: none;
    }
    
    .file-input {
        width: 100%;
        padding: 10px;
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        background: white;
    }
    
    .file-preview {
        margin-top: 10px;
        max-width: 100%;
    }
    
    .preview-image {
        max-width: 100%;
        max-height: 150px;
        border-radius: 8px;
    }
    
    .send-btn {
        width: 100%;
        padding: 15px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
    }
    
    .send-btn:active {
        transform: scale(0.98);
        background: #218838;
    }
    
    .empty-state {
        text-align: center;
        color: #999;
        padding: 40px 20px;
    }
    
    /* Ø­Ø§Ù„Øª Ø®Ø§Ù„ÛŒ */
    .no-user-selected {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        text-align: center;
        padding: 20px;
    }
    
    .no-user-selected i {
        font-size: 4rem;
        margin-bottom: 15px;
        opacity: 0.3;
    }
</style>

<div class="admin-panel">
    <!-- Ù‡Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
    <div class="mobile-header">
        <h1>ğŸ‘¨â€ğŸ’¼ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h1>
        <span class="stats-badge" id="stats-badge">0 Ú©Ø§Ø±Ø¨Ø±</span>
    </div>
    
    <!-- Ù…Ù†ÙˆÛŒ Ù¾Ø§ÛŒÛŒÙ† -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showSection('users')">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
        <div class="nav-item" onclick="showSection('chat')">ğŸ’¬ Ú†Øª</div>
    </div>
    
    <!-- Ø¨Ø®Ø´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
    <div id="users-section" class="users-section active">
        <div class="section-header">
            <h2>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
            <button class="refresh-btn" onclick="loadUsers()">ğŸ”„</button>
        </div>
        <div id="users-grid" class="users-grid">
            <!-- Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ js Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒØ´Ù† -->
        </div>
    </div>
    
    <!-- Ø¨Ø®Ø´ Ú†Øª -->
    <div id="chat-section" class="chat-section">
        <div class="chat-header">
            <button class="back-btn" onclick="showSection('users')">â†</button>
            <div class="selected-user-info">
                <div class="selected-user-name" id="selected-user-name">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</div>
                <div class="selected-user-status" id="selected-user-status">Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
            </div>
        </div>
        
        <div id="messages-container" class="messages-container">
            <div class="no-user-selected">
                <div>ğŸ‘ˆ</div>
                <div>ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
            </div>
        </div>
        
        <div class="message-form" id="message-form" style="display: none;">
            <div class="message-type-row" id="message-type-row">
                <button class="type-btn active" onclick="selectMessageType('text')">ğŸ“ Ù…ØªÙ†</button>
                <button class="type-btn" onclick="selectMessageType('image')">ğŸ–¼ï¸ Ø¹Ú©Ø³</button>
                <button class="type-btn" onclick="selectMessageType('video')">ğŸ¥ ÙˆÛŒØ¯ÛŒÙˆ</button>
                <button class="type-btn" onclick="selectMessageType('audio')">ğŸµ ØµØ¯Ø§</button>
                <button class="type-btn" onclick="selectMessageType('file')">ğŸ“ ÙØ§ÛŒÙ„</button>
            </div>
            
            <div class="input-area">
                <div id="text-input-container">
                    <textarea id="message-text" class="text-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." rows="2"></textarea>
                </div>
                <div id="file-input-container" style="display: none;">
                    <input type="file" id="message-file" class="file-input" accept="*/*">
                    <div id="file-preview" class="file-preview"></div>
                </div>
            </div>
            
            <button class="send-btn" onclick="sendAdminMessage()">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±</button>
        </div>
    </div>
</div>

<script>
const ADMIN_PASSWORD = 'admin123';
let currentUserId = null;
let currentUserName = '';
let currentMessageType = 'text';
let refreshInterval = null;

// Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´â€ŒÙ‡Ø§
function showSection(section) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    document.querySelectorAll('.users-section, .chat-section').forEach(section => section.classList.remove('active'));
    
    if (section === 'users') {
        document.querySelector('.nav-item:first-child').classList.add('active');
        document.getElementById('users-section').classList.add('active');
    } else {
        document.querySelector('.nav-item:last-child').classList.add('active');
        document.getElementById('chat-section').classList.add('active');
    }
}

// Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…
function selectMessageType(type) {
    currentMessageType = type;
    document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (type === 'text') {
        document.getElementById('text-input-container').style.display = 'block';
        document.getElementById('file-input-container').style.display = 'none';
    } else {
        document.getElementById('text-input-container').style.display = 'none';
        document.getElementById('file-input-container').style.display = 'block';
    }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
async function loadUsers() {
    try {
        const response = await fetch(`/api/get_users?password=${ADMIN_PASSWORD}`);
        const data = await response.json();
        
        const grid = document.getElementById('users-grid');
        const statsBadge = document.getElementById('stats-badge');
        
        statsBadge.innerHTML = `${data.users.length} Ú©Ø§Ø±Ø¨Ø±`;
        grid.innerHTML = '';
        
        data.users.forEach(user => {
            const lastActive = new Date(user.last_activity).toLocaleTimeString('fa-IR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const card = document.createElement('div');
            card.className = `user-card ${currentUserId == user.id ? 'active' : ''}`;
            card.onclick = () => selectUser(user.id, user.username);
            
            card.innerHTML = `
                <div class="user-avatar">${user.username.charAt(0)}</div>
                <div class="user-info">
                    <div class="user-name">${user.username}</div>
                    <div class="user-meta">
                        <span>ğŸ’¬ ${user.message_count}</span>
                        <span>ğŸ• ${lastActive}</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    } catch (error) {
        console.error('Ø®Ø·Ø§:', error);
    }
}

// Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±
async function selectUser(userId, username) {
    currentUserId = userId;
    currentUserName = username;
    
    document.getElementById('selected-user-name').innerHTML = username;
    document.getElementById('selected-user-status').innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ú†Øª...';
    document.getElementById('message-form').style.display = 'block';
    
    document.querySelectorAll('.user-card').forEach(card => card.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    await loadMessages(userId);
    
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => loadMessages(userId), 3000);
    
    // Ø¨Ø±Ùˆ Ø¨Ù‡ Ø¨Ø®Ø´ Ú†Øª
    showSection('chat');
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
async function loadMessages(userId) {
    try {
        const response = await fetch(`/api/get_messages?chat_type=admin&password=${ADMIN_PASSWORD}&user_id=${userId}`);
        const data = await response.json();
        
        const container = document.getElementById('messages-container');
        
        if (data.messages.length === 0) {
            container.innerHTML = '<div class="empty-state">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
            return;
        }
        
        container.innerHTML = '';
        
        data.messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.sender}`;
            
            let contentHtml = '';
            const time = new Date(msg.timestamp).toLocaleTimeString('fa-IR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            if (msg.message_type === 'text') {
                contentHtml = `<div class="message-content">${msg.content}</div>`;
            } else if (msg.message_type === 'image' && msg.file_path) {
                contentHtml = `<img src="/uploads/${msg.file_path}" class="message-image" onclick="window.open(this.src)">`;
            } else if (msg.message_type === 'video' && msg.file_path) {
                contentHtml = `<video src="/uploads/${msg.file_path}" controls class="message-video"></video>`;
            } else if (msg.message_type === 'audio' && msg.file_path) {
                contentHtml = `<audio src="/uploads/${msg.file_path}" controls class="message-audio"></audio>`;
            } else if (msg.file_path) {
                contentHtml = `<a href="/uploads/${msg.file_path}" target="_blank" class="message-file">ğŸ“ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</a>`;
            }
            
            const senderName = msg.sender === 'user' ? 'Ú©Ø§Ø±Ø¨Ø±' : (msg.sender === 'admin' ? 'Ø§Ø¯Ù…ÛŒÙ†' : 'Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span>${senderName}</span>
                    <span>${time}</span>
                </div>
                ${contentHtml}
            `;
            
            container.appendChild(messageDiv);
        });
        
        container.scrollTop = container.scrollHeight;
        
    } catch (error) {
        console.error('Ø®Ø·Ø§:', error);
    }
}

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø¯Ù…ÛŒÙ†
async function sendAdminMessage() {
    if (!currentUserId) {
        alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const formData = new FormData();
    formData.append('user_id', currentUserId);
    formData.append('message_type', currentMessageType);
    formData.append('password', ADMIN_PASSWORD);
    
    if (currentMessageType === 'text') {
        const text = document.getElementById('message-text').value;
        if (!text.trim()) {
            alert('Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            return;
        }
        formData.append('content', text);
    } else {
        const file = document.getElementById('message-file').files[0];
        if (!file) {
            alert('ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
            return;
        }
        formData.append('file', file);
    }
    
    try {
        const response = await fetch('/api/admin/send', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            document.getElementById('message-text').value = '';
            document.getElementById('message-file').value = '';
            document.getElementById('file-preview').innerHTML = '';
            await loadMessages(currentUserId);
        } else {
            alert('Ø®Ø·Ø§: ' + result.message);
        }
    } catch (error) {
        console.error('Ø®Ø·Ø§:', error);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…');
    }
}

// Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„
document.getElementById('message-file')?.addEventListener('change', function(e) {
    const preview = document.getElementById('file-preview');
    const file = e.target.files[0];
    
    if (!file) {
        preview.innerHTML = '';
        return;
    }
    
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="preview-image">`;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `<div>ğŸ“ ${file.name}</div>`;
    }
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
});

// Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„
window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
});
</script>
{% endblock %}
