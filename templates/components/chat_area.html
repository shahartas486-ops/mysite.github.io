<div class="chat-area" id="chat-area">
    {% if messages %}
        {% for message in messages %}
            <div class="message {% if message.sender == 'user' %}user-message{% else %}ai-message{% endif %}">
                <div class="message-header">
                    <span class="message-sender">
                        {% if message.sender == 'user' %}
                            <i class="fas fa-user"></i> شما
                        {% else %}
                            <i class="fas fa-robot"></i> دستیار هوش مصنوعی
                        {% endif %}
                    </span>
                    <span class="message-time">{{ message.timestamp|format_time }}</span>
                </div>
                <div class="message-content">
                    {{ message.content|safe }}
                </div>
                {% if message.file_path %}
                    <div class="message-file">
                        {% set file_type = message.file_path.split('.')[-1].lower() %}
                        {% if file_type in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                            <img src="{{ url_for('uploaded_file', filename=message.file_path) }}" 
                                 class="file-preview"
                                 onclick="openFile('{{ url_for('uploaded_file', filename=message.file_path) }}')">
                        {% elif file_type in ['mp4', 'avi', 'mov', 'webm'] %}
                            <video controls class="file-preview">
                                <source src="{{ url_for('uploaded_file', filename=message.file_path) }}" type="video/mp4">
                            </video>
                        {% elif file_type in ['mp3', 'wav', 'ogg'] %}
                            <audio controls>
                                <source src="{{ url_for('uploaded_file', filename=message.file_path) }}">
                            </audio>
                        {% else %}
                            <a href="{{ url_for('uploaded_file', filename=message.file_path) }}" 
                               download 
                               class="file-download">
                                <i class="fas fa-download"></i> دانلود فایل
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <div class="empty-chat">
            <i class="fas fa-comments"></i>
            <h3>چت خالی است</h3>
            <p>شروع به گفتگو با هوش مصنوعی کنید!</p>
        </div>
    {% endif %}
</div>

<script>
// تابع باز کردن فایل در تب جدید
function openFile(url) {
    window.open(url, '_blank');
}

// تابع دانلود فایل
function downloadFile(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || url.split('/').pop();
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>

<style>
.chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 20px;
    margin-bottom: 20px;
}

.empty-chat {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255, 255, 255, 0.5);
}

.empty-chat i {
    font-size: 64px;
    margin-bottom: 20px;
    color: rgba(67, 97, 238, 0.3);
}

.empty-chat h3 {
    font-size: 24px;
    margin-bottom: 10px;
    color: rgba(255, 255, 255, 0.7);
}

.empty-chat p {
    font-size: 16px;
    color: rgba(255, 255, 255, 0.5);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 14px;
}

.message-sender {
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
}

.message-time {
    font-size: 12px;
    opacity: 0.7;
}

.file-download {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: rgba(67, 97, 238, 0.2);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s;
}

.file-download:hover {
    background: rgba(67, 97, 238, 0.4);
    transform: translateY(-2px);
}

/* انیمیشن برای پیام‌های جدید */
@keyframes highlightMessage {
    0% {
        background-size: 0% 100%;
    }
    50% {
        background-size: 100% 100%;
    }
    100% {
        background-size: 0% 100%;
    }
}

.message.new-message {
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(67, 97, 238, 0.1) 50%,
        transparent 100%
    );
    background-size: 200% 100%;
    animation: highlightMessage 2s ease;
}

/* استایل برای کد */
.code-block {
    position: relative;
    margin: 10px 0;
}

.code-block pre {
    margin: 0;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    overflow-x: auto;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    line-height: 1.5;
}

.code-block .copy-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    display: none;
}

.code-block:hover .copy-btn {
    display: block;
}

.code-block .copy-btn:hover {
    background: rgba(67, 97, 238, 0.3);
}

/* استایل برای جداول */
.chat-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    overflow: hidden;
}

.chat-table th,
.chat-table td {
    padding: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    text-align: right;
}

.chat-table th {
    background: rgba(67, 97, 238, 0.2);
    font-weight: bold;
}

.chat-table tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

/* استایل برای لیست‌ها */
.chat-list {
    list-style-type: none;
    padding: 0;
    margin: 10px 0;
}

.chat-list li {
    padding: 8px 15px;
    margin: 5px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border-right: 3px solid #4361ee;
}

.chat-list li:hover {
    background: rgba(67, 97, 238, 0.1);
    transform: translateX(-5px);
}

/* استایل برای نقل قول */
.chat-quote {
    padding: 15px;
    margin: 10px 0;
    background: rgba(67, 97, 238, 0.1);
    border-right: 4px solid #4361ee;
    border-radius: 10px;
    font-style: italic;
    color: rgba(255, 255, 255, 0.9);
}

.chat-quote::before {
    content: '"';
    font-size: 24px;
    color: #4361ee;
    margin-left: 5px;
}

.chat-quote::after {
    content: '"';
    font-size: 24px;
    color: #4361ee;
    margin-right: 5px;
}

/* استایل برای اعلان‌ها */
.chat-alert {
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-alert.info {
    background: rgba(67, 97, 238, 0.1);
    border-right: 4px solid #4361ee;
}

.chat-alert.success {
    background: rgba(76, 201, 240, 0.1);
    border-right: 4px solid #4cc9f0;
}

.chat-alert.warning {
    background: rgba(248, 150, 30, 0.1);
    border-right: 4px solid #f8961e;
}

.chat-alert.error {
    background: rgba(247, 37, 133, 0.1);
    border-right: 4px solid #f72585;
}
</style>
