{% extends "base.html" %}

{% block title %}Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª - Ú†Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ{% endblock %}

{% block content %}
<div class="bg-animation">
    <div class="float-element"></div>
    <div class="float-element"></div>
    <div class="float-element"></div>
</div>

<div class="admin-container">
    <div class="admin-sidebar">
        <div class="admin-header">
            <h2><i class="fas fa-user-shield"></i> Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            <button class="refresh-btn" onclick="refreshUsers()" title="Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <div class="admin-stats" style="
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        ">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
                    <div style="font-size: 24px; font-weight: bold; color: #4cc9f0;" id="online-count">0</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</div>
                    <div style="font-size: 24px; font-weight: bold; color: #f72585;" id="total-messages">0</div>
                </div>
            </div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.6); text-align: center;">
                <i class="fas fa-clock"></i>
                Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="last-update">Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†</span>
            </div>
        </div>
        
        <div class="users-list-header" style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        ">
            <h3 style="color: white; font-size: 18px;">
                <i class="fas fa-users"></i> Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            </h3>
            <div class="user-search" style="position: relative;">
                <input type="text" id="user-search" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±..." style="
                    width: 100%;
                    padding: 10px 35px 10px 15px;
                    background: rgba(255,255,255,0.05);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                ">
                <i class="fas fa-search" style="
                    position: absolute;
                    left: 12px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: rgba(255,255,255,0.5);
                "></i>
            </div>
        </div>
        
        <div class="users-list" id="users-list" style="
            max-height: calc(100vh - 350px);
            overflow-y: auto;
            padding-right: 5px;
        ">
            <!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5);">
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 15px;"></i>
                <div>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...</div>
            </div>
        </div>
    </div>
    
    <div class="admin-main">
        <div class="admin-chat-header" style="
            padding: 20px 30px;
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        ">
            <div>
                <h3 id="selected-user" style="margin-bottom: 5px; font-size: 20px;">
                    <i class="fas fa-user"></i> Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±
                </h3>
                <div id="user-info" style="font-size: 14px; opacity: 0.8;">
                    ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù„ÛŒØ³Øª Ø³Ù…Øª Ø±Ø§Ø³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                </div>
            </div>
            
            <div class="admin-actions" style="display: flex; gap: 10px;">
                <button class="tool-btn" onclick="exportChat()" title="Ø®Ø±ÙˆØ¬ÛŒ Ú†Øª">
                    <i class="fas fa-download"></i>
                </button>
                <button class="tool-btn" onclick="clearAdminChat()" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="tool-btn" onclick="blockUser()" title="Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±">
                    <i class="fas fa-ban"></i>
                </button>
            </div>
        </div>
        
        <div class="admin-chat-container" style="
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 25px;
            background: rgba(255,255,255,0.02);
        ">
            <div class="admin-messages" id="admin-messages" style="
                flex: 1;
                overflow-y: auto;
                padding: 25px;
                margin-bottom: 25px;
                background: rgba(255,255,255,0.02);
                border-radius: 20px;
                border: 1px solid rgba(255,255,255,0.05);
            ">
                <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú†Øª Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.4);">
                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <div style="font-size: 18px; margin-bottom: 10px;">Ú†Øª Ù…Ø¯ÛŒØ±ÛŒØª</div>
                    <div style="font-size: 14px;">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ú†ØªØŒ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù„ÛŒØ³Øª Ø³Ù…Øª Ø±Ø§Ø³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                </div>
            </div>
            
            <div class="admin-input" style="
                background: rgba(255,255,255,0.03);
                padding: 20px;
                border-radius: 20px;
                border: 1px solid rgba(255,255,255,0.1);
            ">
                <div class="admin-tools" style="
                    display: flex;
                    gap: 12px;
                    margin-bottom: 15px;
                ">
                    <button class="tool-btn" onclick="toggleAdminFileInput()" title="Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="tool-btn" onclick="insertAdminLatex()" title="ÙØ±Ù…ÙˆÙ„ Ø±ÛŒØ§Ø¶ÛŒ">
                        <i class="fas fa-square-root-alt"></i>
                    </button>
                    <button class="tool-btn" onclick="insertTemplate()" title="Ù‚Ø§Ù„Ø¨ Ù¾Ø§Ø³Ø®">
                        <i class="fas fa-sticky-note"></i>
                    </button>
                    <button class="tool-btn" onclick="toggleQuickReplies()" title="Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹">
                        <i class="fas fa-reply-all"></i>
                    </button>
                </div>
                
                <div class="admin-file-input" id="admin-file-input" style="
                    display: none;
                    background: rgba(255,255,255,0.05);
                    padding: 20px;
                    border-radius: 15px;
                    margin-bottom: 20px;
                    border: 2px dashed #9b59b6;
                    text-align: center;
                ">
                    <label class="file-label" style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 15px;
                        cursor: pointer;
                        color: #9b59b6;
                        padding: 20px;
                    ">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px;"></i>
                        <span>ÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</span>
                        <input type="file" id="admin-file-upload" multiple accept="image/*,video/*,audio/*,.pdf,.txt">
                    </label>
                    <select id="admin-file-type" style="
                        width: 100%;
                        padding: 10px;
                        background: rgba(26, 26, 46, 0.8);
                        border: 1px solid #9b59b6;
                        border-radius: 10px;
                        color: white;
                        margin-top: 10px;
                    ">
                        <option value="image">ØªØµÙˆÛŒØ±</option>
                        <option value="video">ÙˆÛŒØ¯ÛŒÙˆ</option>
                        <option value="audio">ØµØ¯Ø§</option>
                        <option value="file">ÙØ§ÛŒÙ„</option>
                    </select>
                </div>
                
                <textarea id="admin-message-input" placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." rows="4" style="
                    width: 100%;
                    padding: 18px;
                    background: rgba(255,255,255,0.05);
                    border: 2px solid rgba(255,255,255,0.1);
                    border-radius: 15px;
                    resize: none;
                    font-size: 16px;
                    color: white;
                    margin-bottom: 15px;
                    transition: all 0.3s;
                " onfocus="this.style.borderColor='#9b59b6'; this.style.background='rgba(255,255,255,0.08)'"
                  onblur="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.05)'"></textarea>
                
                <div style="display: flex; gap: 15px;">
                    <button onclick="sendAdminMessage()" style="
                        flex: 1;
                        background: linear-gradient(135deg, #9b59b6, #8e44ad);
                        color: white;
                        border: none;
                        padding: 18px;
                        border-radius: 15px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        transition: all 0.3s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 20px rgba(155, 89, 182, 0.4)'"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <i class="fas fa-paper-plane"></i>
                        Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®
                    </button>
                    
                    <button onclick="saveAsTemplate()" style="
                        background: transparent;
                        color: white;
                        border: 1px solid rgba(255,255,255,0.3);
                        padding: 18px;
                        border-radius: 15px;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.3s;
                        width: 60px;
                    " title="Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù‚Ø§Ù„Ø¨">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="current-user-id">

<!-- Modal LaTeX Ø§Ø¯Ù…ÛŒÙ† -->
<div class="modal" id="admin-latex-modal">
    <div class="modal-content">
        <h3><i class="fas fa-square-root-alt"></i> ÙˆØ±ÙˆØ¯ ÙØ±Ù…ÙˆÙ„ LaTeX</h3>
        <textarea id="admin-latex-input" placeholder="Ù…Ø«Ø§Ù„: \frac{a}{b} = \sqrt{c^2}" rows="5"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn insert" onclick="insertAdminLatexText()">
                <i class="fas fa-plus"></i> Ø¯Ø±Ø¬
            </button>
            <button class="modal-btn cancel" onclick="closeAdminLatexModal()">
                <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
            </button>
        </div>
    </div>
</div>

<!-- Modal Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ -->
<div class="modal" id="quick-replies-modal">
    <div class="modal-content" style="max-width: 600px;">
        <h3><i class="fas fa-reply-all"></i> Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹</h3>
        <div id="quick-replies-list" style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        ">
            <!-- Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        <div class="modal-buttons">
            <button class="modal-btn insert" onclick="addQuickReply()">
                <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø³Ø®
            </button>
            <button class="modal-btn cancel" onclick="closeQuickReplies()">
                <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
            </button>
        </div>
    </div>
</div>

<div class="watermark">Admin Panel v2.0</div>

<script>
// ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†
let currentUserId = null;
let adminMessageInterval = null;
let quickReplies = JSON.parse(localStorage.getItem('admin_quick_replies') || '[]');

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
async function refreshUsers() {
    try {
        const response = await fetch('/api/get_users');
        const data = await response.json();
        
        const usersList = document.getElementById('users-list');
        usersList.innerHTML = '';
        
        let onlineCount = 0;
        let totalMessages = 0;
        
        data.users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';
            userDiv.onclick = () => selectUser(user.id, user.username, user.session_id);
            
            // Ø¨Ø±Ø±Ø³ÛŒ ÙØ¹Ø§Ù„ÛŒØª Ø§Ø®ÛŒØ± (Ú©Ù…ØªØ± Ø§Ø² 5 Ø¯Ù‚ÛŒÙ‚Ù‡)
            const isOnline = user.last_activity && 
                (new Date() - new Date(user.last_activity)) < 5 * 60 * 1000;
            
            if (isOnline) onlineCount++;
            totalMessages += user.message_count || 0;
            
            const lastActivity = user.last_activity ? 
                formatDate(user.last_activity) : 'Ø¨Ø¯ÙˆÙ† ÙØ¹Ø§Ù„ÛŒØª';
            
            userDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div class="user-name" style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 5px;
                        ">
                            <i class="fas fa-user" style="color: ${isOnline ? '#4cc9f0' : 'rgba(255,255,255,0.5)'}"></i>
                            ${user.username}
                            ${isOnline ? '<span class="status-indicator status-online"></span>' : ''}
                        </div>
                        <div class="user-last">
                            <i class="fas fa-clock"></i>
                            ${lastActivity}
                        </div>
                        <div class="user-count">
                            <i class="fas fa-comment"></i>
                            ${user.message_count || 0} Ù¾ÛŒØ§Ù…
                        </div>
                    </div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5); font-family: monospace;">
                        ${user.session_id ? user.session_id.substring(0, 8) + '...' : ''}
                    </div>
                </div>
            `;
            
            usersList.appendChild(userDiv);
        });
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
        document.getElementById('online-count').textContent = onlineCount;
        document.getElementById('total-messages').textContent = totalMessages;
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString('fa-IR');
        
    } catch (error) {
        console.error('Error loading users:', error);
        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'error');
    }
}

// Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±
function selectUser(userId, username, sessionId) {
    currentUserId = userId;
    document.getElementById('current-user-id').value = userId;
    
    document.getElementById('selected-user').innerHTML = `
        <i class="fas fa-user"></i> ${username}
    `;
    
    document.getElementById('user-info').innerHTML = `
        <div style="display: flex; gap: 15px; font-size: 13px;">
            <span><i class="fas fa-id-card"></i> ${sessionId ? sessionId.substring(0, 8) + '...' : 'N/A'}</span>
            <span><i class="fas fa-calendar"></i> ${new Date().toLocaleDateString('fa-IR')}</span>
        </div>
    `;
    
    // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
    document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.user-item').classList.add('active');
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
    loadAdminMessages();
    
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„ Ù‚Ø¨Ù„ÛŒ Ùˆ ØªÙ†Ø¸ÛŒÙ… Ø¬Ø¯ÛŒØ¯
    clearInterval(adminMessageInterval);
    adminMessageInterval = setInterval(loadAdminMessages, 2000);
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
async function loadAdminMessages() {
    if (!currentUserId) return;
    
    try {
        const response = await fetch(`/api/get_messages?user_id=${currentUserId}`);
        const data = await response.json();
        
        const messagesDiv = document.getElementById('admin-messages');
        messagesDiv.innerHTML = '';
        
        if (data.messages.length === 0) {
            messagesDiv.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.4);">
                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <div style="font-size: 18px; margin-bottom: 10px;">Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>
                    <div style="font-size: 14px;">Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯</div>
                </div>
            `;
            return;
        }
        
        data.messages.forEach(msg => {
            addMessageToAdminChat(msg.sender, msg.content, msg.file_path, msg.timestamp);
        });
        
    } catch (error) {
        console.error('Error loading admin messages:', error);
    }
}

// Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Øª Ø§Ø¯Ù…ÛŒÙ†
function addMessageToAdminChat(sender, content, filePath = null, timestamp = null) {
    const messagesDiv = document.getElementById('admin-messages');
    
    // Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ú©Ù†
    if (!content && !filePath) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    let messageContent = '';
    let fileContent = '';
    
    if (filePath) {
        const fileType = filePath.split('.').pop().toLowerCase();
        const fileUrl = `/uploads/${filePath}`;
        
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileType)) {
            fileContent = `<div class="message-file"><img src="${fileUrl}" class="file-preview" onclick="openFile('${fileUrl}')"></div>`;
        } else if (['mp4', 'avi', 'mov', 'webm'].includes(fileType)) {
            fileContent = `<div class="message-file"><video controls class="file-preview"><source src="${fileUrl}" type="video/mp4"></video></div>`;
        } else if (['mp3', 'wav', 'ogg'].includes(fileType)) {
            fileContent = `<div class="message-file"><audio controls><source src="${fileUrl}"></audio></div>`;
        } else {
            fileContent = `<div class="message-file"><a href="${fileUrl}" download class="file-download"><i class="fas fa-download"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</a></div>`;
        }
    }
    
    if (content) {
        messageContent = `<div class="message-content">${content}</div>`;
    }
    
    const time = timestamp ? new Date(timestamp).toLocaleTimeString('fa-IR') : new Date().toLocaleTimeString('fa-IR');
    
    messageDiv.innerHTML = `
        ${messageContent}
        ${fileContent}
        <div class="message-time">${time}</div>
        <div class="message-actions" style="
            position: absolute;
            top: 10px;
            left: 10px;
            display: none;
            gap: 5px;
        ">
            <button onclick="copyMessage('${content.replace(/'/g, "\\'")}')" style="
                background: rgba(0,0,0,0.5);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 12px;
            " title="Ú©Ù¾ÛŒ">
                <i class="fas fa-copy"></i>
            </button>
            <button onclick="deleteMessage(${messageDiv.dataset.id})" style="
                background: rgba(247, 37, 133, 0.5);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 12px;
            " title="Ø­Ø°Ù">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    messageDiv.onmouseenter = () => {
        messageDiv.querySelector('.message-actions').style.display = 'flex';
    };
    
    messageDiv.onmouseleave = () => {
        messageDiv.querySelector('.message-actions').style.display = 'none';
    };
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Ø±Ù†Ø¯Ø± LaTeX
    if (window.MathJax) {
        MathJax.typesetPromise([messageDiv]);
    }
}

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø¯Ù…ÛŒÙ†
async function sendAdminMessage() {
    if (!currentUserId) {
        showNotification('Ù„Ø·ÙØ§ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
        return;
    }
    
    const input = document.getElementById('admin-message-input');
    const message = input.value.trim();
    
    if (!message && !document.getElementById('admin-file-upload').files.length) {
        showNotification('Ù„Ø·ÙØ§ Ù¾ÛŒØ§Ù… ÛŒØ§ ÙØ§ÛŒÙ„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('user_id', currentUserId);
    formData.append('message_type', 'text');
    formData.append('content', message);
    
    // ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡
    const fileInput = document.getElementById('admin-file-upload');
    if (fileInput.files.length > 0) {
        const fileType = document.getElementById('admin-file-type').value;
        formData.append('message_type', fileType);
        
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('file', fileInput.files[i]);
        }
        
        fileInput.value = '';
        document.getElementById('admin-file-input').style.display = 'none';
    }
    
    try {
        const response = await fetch('/api/admin/send', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            input.value = '';
            loadAdminMessages();
            showNotification('Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯', 'success');
        } else {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…', 'error');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…', 'error');
    }
}

// Ú©Ù¾ÛŒ Ù¾ÛŒØ§Ù…
function copyMessage(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Ù¾ÛŒØ§Ù… Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
    });
}

// Ø­Ø°Ù Ù¾ÛŒØ§Ù…
function deleteMessage(messageId) {
    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
        // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ API Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø±Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú©Ù†ÛŒØ¯
        showNotification('Ù¾ÛŒØ§Ù… Ø­Ø°Ù Ø´Ø¯', 'success');
    }
}

// Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
function toggleAdminFileInput() {
    const fileInput = document.getElementById('admin-file-input');
    fileInput.style.display = fileInput.style.display === 'none' ? 'block' : 'none';
}

// Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø§Ø² Ú†Øª
function exportChat() {
    if (!currentUserId) {
        showNotification('Ù„Ø·ÙØ§ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
        return;
    }
    
    // Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ
    const chatContent = collectChatContent();
    const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat_export_${currentUserId}_${Date.now()}.txt`;
    a.click();
    
    URL.revokeObjectURL(url);
    showNotification('Ú†Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
}

function collectChatContent() {
    const messages = document.querySelectorAll('#admin-messages .message');
    let content = 'Ú†Øª Ø§Ú©Ø³Ù¾ÙˆØ±Øª\n';
    content += 'ØªØ§Ø±ÛŒØ®: ' + new Date().toLocaleString('fa-IR') + '\n';
    content += '='.repeat(50) + '\n\n';
    
    messages.forEach(msg => {
        const sender = msg.classList.contains('user-message') ? 'Ú©Ø§Ø±Ø¨Ø±' : 
                      msg.classList.contains('admin-message') ? 'Ù…Ø¯ÛŒØ±' : 'Ø³ÛŒØ³ØªÙ…';
        const text = msg.querySelector('.message-content')?.textContent || '';
        const time = msg.querySelector('.message-time')?.textContent || '';
        
        content += `[${time}] ${sender}: ${text}\n`;
    });
    
    return content;
}

// Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª Ø§Ø¯Ù…ÛŒÙ†
function clearAdminChat() {
    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú†Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
        const messagesDiv = document.getElementById('admin-messages');
        if (messagesDiv) {
            messagesDiv.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.4);">
                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <div style="font-size: 18px; margin-bottom: 10px;">Ú†Øª Ù¾Ø§Ú© Ø´Ø¯</div>
                    <div style="font-size: 14px;">Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯</div>
                </div>
            `;
            showNotification('Ú†Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯', 'success');
        }
    }
}

// Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±
function blockUser() {
    if (!currentUserId) {
        showNotification('Ù„Ø·ÙØ§ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
        return;
    }
    
    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
        // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ API Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú©Ù†ÛŒØ¯
        showNotification('Ú©Ø§Ø±Ø¨Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯', 'success');
    }
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹
function toggleQuickReplies() {
    document.getElementById('quick-replies-modal').style.display = 'flex';
    loadQuickReplies();
}

function closeQuickReplies() {
    document.getElementById('quick-replies-modal').style.display = 'none';
}

function loadQuickReplies() {
    const listDiv = document.getElementById('quick-replies-list');
    listDiv.innerHTML = '';
    
    if (quickReplies.length === 0) {
        listDiv.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5);">
                <i class="fas fa-sticky-note" style="font-size: 48px; margin-bottom: 20px;"></i>
                <div>Ù‡ÛŒÚ† Ù¾Ø§Ø³Ø®ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        `;
        return;
    }
    
    quickReplies.forEach((reply, index) => {
        const replyDiv = document.createElement('div');
        replyDiv.className = 'quick-reply-item';
        replyDiv.style.cssText = `
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
        `;
        
        replyDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 8px; color: #9b59b6;">
                ${reply.title || 'Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹'}
            </div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 10px;">
                ${reply.content.substring(0, 100)}${reply.content.length > 100 ? '...' : ''}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: rgba(255,255,255,0.5);">
                <button onclick="useQuickReply(${index})" style="
                    background: #9b59b6;
                    color: white;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 11px;
                ">
                    <i class="fas fa-paper-plane"></i> Ø§Ø³ØªÙØ§Ø¯Ù‡
                </button>
                <button onclick="deleteQuickReply(${index})" style="
                    background: transparent;
                    color: #f72585;
                    border: none;
                    cursor: pointer;
                ">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        replyDiv.onmouseenter = () => {
            replyDiv.style.background = 'rgba(155, 89, 182, 0.1)';
            replyDiv.style.transform = 'translateY(-2px)';
        };
        
        replyDiv.onmouseleave = () => {
            replyDiv.style.background = 'rgba(255,255,255,0.05)';
            replyDiv.style.transform = 'translateY(0)';
        };
        
        listDiv.appendChild(replyDiv);
    });
}

function addQuickReply() {
    const content = prompt('Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
    if (content) {
        const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ù¾Ø§Ø³Ø® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):', 'Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹');
        quickReplies.push({
            title: title || 'Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹',
            content: content,
            created: new Date().toISOString()
        });
        
        localStorage.setItem('admin_quick_replies', JSON.stringify(quickReplies));
        loadQuickReplies();
        showNotification('Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯', 'success');
    }
}

function useQuickReply(index) {
    const reply = quickReplies[index];
    const input = document.getElementById('admin-message-input');
    if (input) {
        input.value = reply.content;
        input.focus();
        closeQuickReplies();
    }
}

function deleteQuickReply(index) {
    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
        quickReplies.splice(index, 1);
        localStorage.setItem('admin_quick_replies', JSON.stringify(quickReplies));
        loadQuickReplies();
        showNotification('Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹ Ø­Ø°Ù Ø´Ø¯', 'success');
    }
}

function saveAsTemplate() {
    const input = document.getElementById('admin-message-input');
    const content = input.value.trim();
    
    if (content) {
        addQuickReply();
    } else {
        showNotification('Ù„Ø·ÙØ§ Ù…ØªÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'warning');
    }
}

function insertTemplate() {
    // Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§
    const templates = [
        { title: 'Ø³Ù„Ø§Ù… Ùˆ Ø§Ø­ÙˆØ§Ù„Ù¾Ø±Ø³ÛŒ', content: 'Ø³Ù„Ø§Ù…! Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©ØªÙˆÙ† Ú©Ù†Ù…ØŸ ğŸ˜Š' },
        { title: 'ØªØ´Ú©Ø±', content: 'Ø®ÙˆØ§Ù‡Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ù…! Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú© Ú©Ù†Ù…. ğŸ¤—' },
        { title: 'Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯', content: 'Ù„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ØŒ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø³ÙˆØ§Ù„ Ø´Ù…Ø§ Ù‡Ø³ØªÙ…... ğŸ”„' },
        { title: 'Ù¾Ø§ÛŒØ§Ù† Ú†Øª', content: 'Ù…Ù…Ù†ÙˆÙ† Ø§Ø² Ø´Ù…Ø§! Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ Ø¯ÛŒÚ¯Ù‡â€ŒØ§ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¯Ø± Ø®Ø¯Ù…ØªÙ…. ğŸ‘‹' },
        { title: 'Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', content: 'Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.' }
    ];
    
    const templateList = templates.map((t, i) => 
        `<option value="${i}">${t.title}</option>`
    ).join('');
    
    const selected = prompt(
        'Ù‚Ø§Ù„Ø¨ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n' + 
        templates.map((t, i) => `${i+1}. ${t.title}`).join('\n') + 
        '\n\nØ´Ù…Ø§Ø±Ù‡ Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'
    );
    
    if (selected && templates[selected - 1]) {
        const template = templates[selected - 1];
        const input = document.getElementById('admin-message-input');
        if (input) {
            input.value = template.content;
            input.focus();
        }
    }
}

// Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±
document.getElementById('user-search')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const userItems = document.querySelectorAll('.user-item');
    
    userItems.forEach(item => {
        const username = item.querySelector('.user-name').textContent.toLowerCase();
        if (username.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener('DOMContentLoaded', function() {
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    refreshUsers();
    adminMessageInterval = setInterval(refreshUsers, 5000);
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Enter Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
    const adminMessageInput = document.getElementById('admin-message-input');
    if (adminMessageInput) {
        adminMessageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAdminMessage();
            }
        });
    }
    
    // Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø¨Ø§Øª Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
    createAdminBotAnimation();
});

// Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø±Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
function createAdminBotAnimation() {
    const botDiv = document.createElement('div');
    botDiv.className = 'bot-animation';
    botDiv.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 80px;
        height: 80px;
        z-index: 100;
        pointer-events: none;
    `;
    
    botDiv.innerHTML = `
        <svg viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="#9b59b6" opacity="0.8"/>
            <circle cx="40" cy="40" r="5" fill="white"/>
            <circle cx="60" cy="40" r="5" fill="white"/>
            <path d="M35,65 Q50,75 65,65" stroke="white" stroke-width="3" fill="none"/>
            <path d="M30,20 Q50,10 70,20" stroke="white" stroke-width="2" fill="none"/>
            <path d="M45,85 Q50,90 55,85" stroke="white" stroke-width="2" fill="none"/>
        </svg>
    `;
    
    document.body.appendChild(botDiv);
}

console.log('Admin panel initialized');
</script>

<style>
/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† */
.admin-stats {
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(76, 201, 240, 0.1));
}

.user-item {
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.user-item:hover {
    border-color: #4361ee;
    transform: translateX(-5px);
}

.user-item.active {
    border-color: #9b59b6;
    background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), rgba(142, 68, 173, 0.1));
}

.quick-reply-item:hover {
    background: rgba(155, 89, 182, 0.1) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 5px 15px rgba(155, 89, 182, 0.2) !important;
}

.admin-actions .tool-btn:hover {
    background: #9b59b6;
    transform: scale(1.1);
}

#admin-message-input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.2);
}
</style>
{% endblock %}